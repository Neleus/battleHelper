if (location.pathname.indexOf("leader_guild.php") >= 0) {
    var turnId = {amummy:{id:933,hp:80},acrossbowman:{id:1021,hp:24},air:{id:153,hp:30},ancienent:{id:238,hp:181},ancientpig:{id:691,hp:15},angel:{id:132,hp:180},anubis:{id:917,hp:160},arcaneelf:{id:261,hp:12},archer:{id:2,hp:7},archlich:{id:146,hp:55},archmage:{id:104,hp:30},armorgnom:{id:982,hp:55},assassin:{id:56,hp:14},assida:{id:847,hp:30},axegnom:{id:985,hp:10},banditka:{id:729,hp:8},banshee:{id:515,hp:110},battlegriffin:{id:36,hp:35},battlegriffon:{id:493,hp:52},battlemage:{id:578,hp:29},battlerager:{id:960,hp:30},bear:{id:172,hp:22},bearrider:{id:161,hp:25},behemoth:{id:131,hp:210},berserker:{id:163,hp:25},bigspider:{id:724,hp:55},blackbearrider:{id:162,hp:30},blackknight:{id:272,hp:90},blackwidow:{id:661,hp:14},bloodsister:{id:315,hp:24},boar:{id:690,hp:17},boarrider:{id:318,hp:14},bobbit:{id:895,hp:6},bonedragon:{id:133,hp:150},brawler:{id:114,hp:20},brigand:{id:725,hp:5},briskrider:{id:316,hp:50},brute:{id:254,hp:8},cavalier:{id:90,hp:90},cbal:{id:791,hp:65},cerberus:{id:75,hp:15},champion:{id:495,hp:100},chieftain:{id:436,hp:48},colossus:{id:106,hp:175},conscript:{id:34,hp:6},cpirate:{id:677,hp:4},crossman:{id:257,hp:8},crusader:{id:672,hp:30},cursed:{id:522,hp:20},cursedent:{id:664,hp:215},cyclop:{id:89,hp:85},cyclopking:{id:237,hp:95},cyclopod:{id:537,hp:100},dancer:{id:25,hp:12},darkbird:{id:544,hp:60},darkrider:{id:51,hp:40},ddhigh:{id:587,hp:34},deephydra:{id:149,hp:125},defender:{id:157,hp:7},devil:{id:82,hp:166},dgolem:{id:520,hp:350},diamondgolem:{id:660,hp:60},djinn:{id:39,hp:40},djinn_sultan:{id:105,hp:45},djinn_vizier:{id:579,hp:50},druid:{id:26,hp:34},druideld:{id:120,hp:38},dryad:{id:255,hp:6},eadaughter:{id:333,hp:35},earth:{id:154,hp:75},efreeti:{id:280,hp:90},elf:{id:19,hp:10},elgargoly:{id:256,hp:16},enforcer:{id:35,hp:7},executioner:{id:335,hp:40},familiar:{id:80,hp:6},fatpirate:{id:651,hp:100},fatpirateup:{id:652,hp:120},fcentaur:{id:310,hp:6},fire:{id:155,hp:43},firebird:{id:536,hp:65},firedragon:{id:168,hp:230},flamelord:{id:958,hp:120},footman:{id:10,hp:16},foulhydra:{id:746,hp:125},foulwyvern:{id:337,hp:105},fury:{id:53,hp:16},ghost:{id:11,hp:8},giant:{id:792,hp:100},giantarch:{id:817,hp:100},gnomon:{id:728,hp:9},goblin:{id:14,hp:3},goblinarcher:{id:314,hp:3},goblinmag:{id:545,hp:3},goblinus:{id:329,hp:3},gogachi:{id:285,hp:13},greendragon:{id:103,hp:200},gremlin:{id:9,hp:5},griffon:{id:3,hp:30},grimrider:{id:121,hp:50},harpooner:{id:378,hp:10},harpy:{id:200,hp:15},harpyhag:{id:201,hp:15},hellcharger:{id:76,hp:50},hellhound:{id:74,hp:15},hellkon:{id:290,hp:66},highwayman:{id:730,hp:24},hobgoblin:{id:33,hp:4},horneddemon:{id:77,hp:13},hornedoverseer:{id:79,hp:13},hotdog:{id:288,hp:15},hydra:{id:50,hp:80},hyenarider:{id:859,hp:14},imp:{id:78,hp:4},impergriffin:{id:117,hp:35},inquisitor:{id:145,hp:80},iron_golem:{id:12,hp:18},jdemon:{id:289,hp:13},kachok:{id:601,hp:50},kamneed:{id:202,hp:45},kamnegryz:{id:203,hp:55},leprekon:{id:610,hp:7},lich:{id:29,hp:50},mage:{id:16,hp:18},magneticgolem:{id:259,hp:28},maiden:{id:49,hp:16},manticore:{id:754,hp:80},marksman:{id:42,hp:10},mastergremlin:{id:32,hp:6},masterhunter:{id:72,hp:14},masterlich:{id:341,hp:55},matriarch:{id:239,hp:90},mauler:{id:320,hp:12},mcentaur:{id:309,hp:10},medusa:{id:752,hp:25},medusaup:{id:753,hp:30},megogachi:{id:287,hp:13},mercarcher:{id:20,hp:8},mercfootman:{id:21,hp:24},minotaur:{id:55,hp:31},minotaurguard:{id:70,hp:35},mistress:{id:745,hp:100},mountaingr:{id:339,hp:12},mummy:{id:268,hp:50},ncentaur:{id:311,hp:9},negro:{id:849,hp:17},nightmare:{id:150,hp:66},nomad:{id:897,hp:30},obsgargoyle:{id:44,hp:20},ocean:{id:848,hp:30},ogre:{id:24,hp:50},ogrebrutal:{id:535,hp:70},ogremagi:{id:119,hp:65},ogreshaman:{id:855,hp:55},orc:{id:23,hp:12},orcchief:{id:73,hp:18},orcrubak:{id:534,hp:20},orcshaman:{id:546,hp:13},outlaw:{id:727,hp:6},outlawup:{id:896,hp:8},peasant:{id:4,hp:4},pegasus:{id:625,hp:30},pikeman:{id:1004,hp:15},piratemonster:{id:644,hp:190},piratka:{id:649,hp:10},piratkaup:{id:650,hp:12},pitfiend:{id:83,hp:110},pitlord:{id:236,hp:120},pity:{id:291,hp:140},pixel:{id:17,hp:5},plaguezombie:{id:40,hp:17},plant:{id:624,hp:60},poltergeist:{id:512,hp:20},priest:{id:37,hp:54},priestess:{id:852,hp:35},priestessup:{id:853,hp:35},pristineunicorn:{id:588,hp:80},rakshasa_kshatra:{id:580,hp:135},rakshasa_raja:{id:108,hp:140},rakshasa_rani:{id:93,hp:120},rapukk:{id:283,hp:99},reptiloid:{id:850,hp:80},reptiloidup:{id:851,hp:90},robber:{id:726,hp:5},rocbird:{id:30,hp:55},rotzombie:{id:270,hp:23},runekeeper:{id:961,hp:65},runepatriarch:{id:165,hp:70},runepriest:{id:164,hp:60},saboteurgremlin:{id:253,hp:6},satyr:{id:626,hp:36},savageent:{id:589,hp:175},sceletonwar:{id:267,hp:5},scout:{id:52,hp:10},sdaughter:{id:332,hp:35},seducer:{id:485,hp:26},shadowdragon:{id:102,hp:200},shadow_witch:{id:94,hp:80},shamancyclop:{id:860,hp:105},shamaness:{id:331,hp:30},shieldguard:{id:158,hp:12},shootpirate:{id:646,hp:15},shootpirateup:{id:647,hp:18},silverunicorn:{id:147,hp:77},skeleton:{id:1,hp:4},skeletonarcher:{id:28,hp:4},skeletonpirate:{id:604,hp:4},skeletonpirateup:{id:606,hp:4},skirmesher:{id:160,hp:12},skmarksman:{id:340,hp:6},slayer:{id:334,hp:34},snowwolf:{id:942,hp:50},spearwielder:{id:159,hp:10},spectre:{id:68,hp:19},spegasus:{id:629,hp:30},spider:{id:198,hp:9},spiderpois:{id:199,hp:11},sprite:{id:31,hp:6},squire:{id:71,hp:26},stalker:{id:696,hp:15},steelgolem:{id:69,hp:24},stone_gargoyle:{id:8,hp:15},succubus:{id:81,hp:20},succubusmis:{id:122,hp:30},taskmaster:{id:317,hp:40},tengu:{id:793,hp:45},thane:{id:166,hp:100},thiefarcher:{id:124,hp:40},thiefmage:{id:125,hp:30},thiefwarrior:{id:123,hp:45},throwgnom:{id:993,hp:24},thunderbird:{id:148,hp:65},thunderlord:{id:167,hp:120},trapper:{id:386,hp:7},treant:{id:92,hp:175},troglodyte:{id:750,hp:5},troglodyteup:{id:751,hp:6},troll:{id:204,hp:150},unicorn:{id:38,hp:57},vampire:{id:15,hp:30},vampirelord:{id:118,hp:35},vampireprince:{id:513,hp:40},vermin:{id:281,hp:6},vindicator:{id:260,hp:23},vulture:{id:731,hp:40},wardancer:{id:41,hp:12},warmong:{id:330,hp:20},warrior:{id:319,hp:12},water:{id:156,hp:43},wdancer:{id:258,hp:14},whitebearrider:{id:959,hp:30},wight:{id:91,hp:95},wolfraider:{id:43,hp:12},wolfrider:{id:18,hp:10},wraith:{id:235,hp:100},wyvern:{id:336,hp:90},zealot:{id:494,hp:80},zombie:{id:5,hp:17},zpirate:{id:679,hp:150},archangel:{id:249,hp:220},seraph2:{id:496,hp:220},spectraldragon:{id:300,hp:160},ghostdragon:{id:514,hp:150},titan:{id:107,hp:190},stormtitan:{id:581,hp:190},emeralddragon:{id:100,hp:200},crystaldragon:{id:590,hp:200},ancientbehemoth:{id:301,hp:250},dbehemoth:{id:538,hp:280},cursedbehemoth:{id:861,hp:250},blackdragon:{id:101,hp:240},reddragon:{id:747,hp:235},archdevil:{id:292,hp:199},archdemon:{id:293,hp:211},magmadragon:{id:169,hp:280},lavadragon:{id:962,hp:275},untamedcyc:{id:433,hp:225},bloodeyecyc:{id:399,hp:235},cyclopus:{id:397,hp:220},paladin:{id:234,hp:100},efreetisultan:{id:282,hp:100},naga:{id:673,hp:110},golddragon:{id:609,hp:169},pharaoh:{id:269,hp:70},deadknight:{id:273,hp:100},zhryak:{id:284,hp:99},ballista:{id:85,hp:200},tent:{id:0,hp:0},piratemonsterup:{id:645,hp:200},blacktroll:{id:205,hp:180},zasad:{id:1047,hp:70},magicel:{id:662,hp:80},scorp:{id:923,hp:4},duneraider:{id:921,hp:12},scorpup:{id:924,hp:5},dromad:{id:919,hp:40},duneraiderup:{id:922,hp:12},shakal:{id:925,hp:24},slon:{id:931,hp:100},priestmoon:{id:929,hp:50},slonup:{id:932,hp:110},shakalup:{id:926,hp:30},dromadup:{id:920,hp:45},priestsun:{id:930,hp:55},anubisup:{id:918,hp:200},scarab:{id:927,hp:6},scarabup:{id:928,hp:6},tenguup:{id:937,hp:60},gnoll:{id:1041,hp:6},brigandup:{id:1038,hp:6},verblud:{id:1060,hp:35},gnollum:{id:1042,hp:6},krokodil:{id:1067,hp:70},krokodilup:{id:1068,hp:80},gnollsh:{id:1089,hp:6},smaster:{id:1095,hp:84},manticoreup:{id:755,hp:80},apirate:{id:612,hp:13},bpirate:{id:611,hp:16},wendigoup:{id:945,hp:35},whitetiger:{id:631,hp:35},dgolemup:{id:521,hp:400},exile:{id:1040,hp:28},banditkaup:{id:936,hp:9},nomadup:{id:938,hp:33},spearthrower:{id:1114,hp:19},gatekeeper:{id:1132,hp:120},gnollup:{id:1138,hp:9},gnollka:{id:1139,hp:6},gnollboss:{id:1140,hp:36},pushkar:{id:1055,hp:64},robberup:{id:1044,hp:6},sekhmet:{id:1062,hp:50},valkyrie:{id:1185,hp:61},goblinshaman:{id:1193,hp:5},poukai:{id:1194,hp:120},monk:{id:1221,hp:20},warden:{id:1223,hp:39},snowwolfup:{id:1165,hp:53},necrodogup:{id:1325,hp:9},necrodog:{id:1324,hp:8},blackarcher:{id:1311,hp:13},deadarcher:{id:1312,hp:16},ork:{id:1346,hp:24},grib:{id:1187,hp:20},gribok:{id:1188,hp:16}};
    var imgId = {mundus:'acrossbowman',assasin:'assassin',ocean:'assida',knight:'cavalier',crossbowman:'crossman',cursed_:'cursed',cyclopod_:'cyclopod',lizardrider:'darkrider',dd_:'druid',ddeld:'druideld',dryad_:'dryad',firebird_:'firebird',gog:'gogachi',nightmare:'hellcharger',demondog:'hellhound',hellstallion:'hellkon',hdemon:'horneddemon',fdemon:'hornedoverseer',firehound:'hotdog',golem:'iron_golem',lepr:'leprekon',hunterelf:'masterhunter',magog:'megogachi',minotaurguard_:'minotaurguard',stallion:'nightmare',obsgargoly:'obsgargoyle',assida:'ocean',paesant:'peasant',pitfiend_:'pitfiend',pitlord_:'pitlord',pitspawn:'pity',pp:'pixel',rakshas:'rakshasa_rani',roc:'rocbird',witch:'shadow_witch',cyclopshaman:'shamancyclop',sceleton:'skeleton',sceletonarcher:'skeletonarcher',dpirate:'skeletonpirate',dpirateup:'skeletonpirateup',swordman:'squire',gargoly:'stone_gargoyle',succub:'succubus',succubusm:'succubusmis',ent:'treant',bladedancer:'wardancer',winddancer:'wdancer',hobwolfrider:'wolfraider',abehemoth:'ancientbehemoth',bbehemoth:'cursedbehemoth',zhrica:'priestmoon',zhricaup:'priestsun',mmaster:'smaster',jpirate:'spearthrower',witchdoctor:'goblinshaman',paokai:'poukai',deaddog:'necrodogup',blackdog:'necrodog'};
	let tr = document.getElementById("gl_tasks").getElementsByTagName("tr");
	for (let i = 0; i < tr.length; i++) {
		if (tr[i].childNodes.length != 1) {
			continue;
		}
		let cre = tr[i].getElementsByClassName("cre_creature");
		let checkSum = 0;
		let hp = 0;
		let f = true;
		for (let j = 0; j < cre.length; j++) {
			let id = cre[j].innerHTML.match(/name=([^\"]+)/)[1];
			let count = cre[j].querySelector("#add_now_count").innerHTML;
			checkSum += turnId[id].id*count;
			hp += turnId[id].hp*count;
		}
		if ((checkSum > 0) && (hp > 0)) {
			tr[i].querySelector("td").innerHTML += "<div style = 'margin-left:10px'><a href = 'https://daily.heroeswm.ru/leader/bandits.php?hp=" + hp + "&sum=" + checkSum + "'>Поиск боя на Daily (beta)</a></div>";
		}
	}
}


if (((location.pathname.indexOf("war.php") >= 0)||(location.pathname.indexOf("warlog.php") >= 0))&&(location.href.indexOf("show_enemy") == -1)) {
	
	let lastMagic_button = document.createElement('div');
	lastMagic_button.style.display = "none";
	lastMagic_button.id = "lastMagic_button";
	lastMagic_button.className = "toolbars_img";
	lastMagic_button.innerHTML = "<img id = 'lastMagicSrc' src='' style = 'background-image: url(https://daily.heroeswm.ru/i/lastMagic_button.png);background-size: contain;'>";
	document.querySelector("#magicbook_button_close").after(lastMagic_button);	
	var like_flash = false;
	updateOrientation();
	var timerIdn = setInterval(check, 100);
	
	
	function check() {

		if (document.getElementById("play_button").style.display == 'none') {
			window.gpause = false;
		}
		if ((typeof(stage) !== 'undefined') && (typeof(stage.pole) !== 'undefined') && (typeof(stage.pole.onMouseMoveFlash) === "function")) {
			clearInterval(timerIdn);
			if (typeof(lastMagic_button_release) !== 'undefined') {
				return 0;
			}

			window.hide_war_buttons = function(hide_all) {//скрываем кнопку вместе с остальными
				//			info_button = false;
				shift_button = false;
				hide_button('scroll_runes');
				hide_button('oneskill_button');
				hide_button('oneskill_button');
				hide_button('oneskill_button_close');
				hide_button('btn_expand');
				hide_button('btn_collapse');
				hide_button('lastMagic_button');
				hide_button('rune_off_button');
				//			hide_button('btn_defeat');
				btn_defeat = 0;
				hide_button('shift_on');
				hide_button('shift_off');
				//			if (inserted) hide_button('info_on');
				//			hide_button('info_off');
				hide_button('rune_button');
				hide_button('win_RunesDesktop');
				hide_button('btn_runesDesktop');
				if (hide_all) {
					hide_button('wait_button');
					hide_button('defend_button');
					hide_button('wait_button2');
					hide_button('defend_button2');
				} else {
					disable_button('wait_button');
					disable_button('defend_button');
					disable_button('wait_button2');
					disable_button('defend_button2');
				};

				hide_button('confirm_todo');
				hide_button('cancel_todo');
				hide_button('magic_book');
				hide_button('magicbook_button');
				hide_button('magicbook_button_close');
				hide_button('magicbook_button2');
				hide_button('magicbook_button_close2');
				if (android) show_coords(0, 0);

				if (typeof mini_info_panel !== 'undefined') {
					set_visible(mini_info_panel, 0);
					if ((btype == 20) || (btype == _SURVIVAL_GNOM) || (btype == _2SURVIVAL)) {
						stage[war_scr].showmitnv();
					};
				};
			};
			
			window.spell_button_release = function(b) {//записываем заклинание в lastMagicUse и lastMagicUse_powered у существа
				if (btype == 87) return 0;
				var cast = spell_id[b];
				book_closed_timer = Date.now();
				//	hide_magic_book();
				hide_button('magic_book');
				magicuse = cast;
				need_hide_hint_arrow = false;

				if ((magic_book_hints) && ((cast == 'raisedead') || (cast == 'fast'))) {
					stage[war_scr].hide_hint_arrow_data();
					if (cast == 'fast') {
						stage[war_scr].show_fast_hints();
					};
					need_hide_hint_arrow = true;
				};



				if ((cast == 'raisedead') || (cast == 'resurrection')) {
					stage[war_scr].showraisedead();
				};
				if (cast == 'zakarrow') {
					zakarrow = true;
					bookpage = 0;
					stage[war_scr].checkpage();
					stage[war_scr].showmagicbook(0, 1);
					show_button('magic_book');
					return 0;
				};
				
				stage.pole.obj[activeobj]["lastMagicUse"] = magicuse;
				stage.pole.obj[activeobj]["lastMagicUse_powered"] = spell_powered[b];
				
				console.log("lastMagicUse =", stage.pole.obj[activeobj]["lastMagicUse"]);
				
				if ((cast == 'explosion') || (cast == 'manafeed') || (cast == 'invisibility') || (cast == 'summonel') || (cast == 'earthquake') || (cast == 'rallingcry') || (cast == 'battlecry') || (cast == 'summonphoenix') || (cast == 'siphonmana') || (cast == 'benediction') || (cast == 'channeling') || (cast == 'invisible') || (cast == 'summonel_f') || (cast == 'summonel_e') || (cast == 'summonel_a') || (cast == 'summonel_w') || (cast == 'elfshot') || (cast.substr(0, 14) == 'summoncreature')) {
					magicuse = '';
					var cast_use = cast;
					if (cast == 'invisibility') cast_use = 'invisible';
					stage[war_scr].custommagic(cast_use);
					hide_magic_book();
				};
				if (cast == 'satyrmorale') magicuse = 'moraler';
				if (cast == 'summonpitlords') magicuse = 'summonpit';
				if (cast == 'leap') {
					stage[war_scr].showleap();
				};
				if (cast == 'leap6') {
					stage[war_scr].showleap();
				};
				carryo = -1;
				magicpower = spell_powered[b];
				
				
				if (spelldamng.includes(cast)) checkmagicbook();
			};

			window.onkeydown = function(e) {//добавляем хоткеи на shift C и F
				if (typeof keys === 'undefined') return 0;
				
				if (((event.shiftKey && event.code === 'KeyC') || (event.code === 'KeyF')) && (typeof buttons_visible !== 'undefined') && (buttons_visible['lastMagic_button'])) {
					lastMagic_button_release();
					return 0;
				}
				
				if ((typeof keys[e.keyCode] !== 'undefined') && (!keys[e.keyCode]) && (keys[e.keyCode] != -1)) {
					if ((shift_ok) && (e.keyCode == 16)) {
						shift_onRelease();
					};
					if ((e.keyCode == 17) && (typeof buttons_visible !== 'undefined') && ((buttons_visible['info_off']) || (buttons_visible['info_on']))) {
						info_onRelease();
					};
				} else {
					if (keys[e.keyCode] == -1) return 0;
				};
				if (!keys[e.keyCode]) check_keys(e.keyCode);
				keys[e.keyCode] = true;
				movecounter = 0;

				if (typeof stage === 'undefined') return 0;
				if (typeof stage[war_scr] === 'undefined') return 0;
				if (typeof stage[war_scr].onMouseMoveFlash !== 'function') return 0;
				stage[war_scr].onMouseMoveFlash(false, mousePos.x, mousePos.y, 1);
				movemouse = true;
			}
		
			window.lastMagic_button_release = function() {
				stage.pole.lastMagic_button_onRelease();
			};	
			
			if (document.getElementById('lastMagic_button')) {
				document.getElementById('lastMagic_button').addEventListener("mouseup", lastMagic_button_release);
			};
			
			window.stage.pole.lastMagic_button_onRelease = function() {
				if ((buttons_visible['magicbook_button_close']) || (buttons_visible['magicbook_button_close2'])) {hide_magic_book(); return 0};
				show_button('magic_book')
				if (classic_chat) {
					show_button('magicbook_button_close2');
				} else {
					show_button('magicbook_button_close');
				}
				hide_button('magicbook_button');
				hide_button('magicbook_button2');
				window.spell_button_release(0);
			}

			window.stage.pole.showmagicbook = function(page, iszak, check_spell, oneCheckPossibleSpell = "") {
			var k = 0,
				j = 0,
				s = '',
				so = '',
				book_txt = '',
				was_spell = 0;
			lastpage = page;
			if (iszak != 1) zakarrow = false;

			function proccedinbook(so, powered, showed_cnt, oneCheckPossibleSpell = "") {

				if ((so == 'zakarrow') && ((zakarrow == true) || ((magic[activeobj]['za2']) && (magic[activeobj]['za2']['effect'] > 0)))) return 0;
				j = k % spell_per_page;
				var cost = stage[war_scr].obj[activeobj][s + 'cost'];
				if (powered) {
					cost *= 2;
				};
				kz = 1;
				var kz2 = 1;
				if ((isperk(activeobj, 110)) && (stage[war_scr].obj[activeobj].hero)) {
					kz *= 0.8
				}; /*'arcane_training'*/
				if ((isperk(activeobj, 87)) && (!stage[war_scr].obj[activeobj].hero)) {
					kz = 0.5
				}; /*refined_mana*/
				if ((isperk(activeobj, 111)) && (stage[war_scr].obj[activeobj].hero)) {
					kz *= 0.8;
				}; /*'erratic_mana'*/

				if (magic[activeobj]['dnn']) {
					var sp_bonus = 1.03 + umelka[stage[war_scr].obj[activeobj]['owner']][10] * 0.03;
					if (is_day_or_night(activeobj, s)) {
						kz2 /= sp_bonus;
					}
				}

				cost = Math.round(cost * kz);
				cost = Math.round(cost * eco * kz2);
				if (s == 'manafeed') {
					cost = Math.min(stage[war_scr].obj[activeobj].nowmanna, stage[war_scr].obj[activeobj].nownumber);
				};

				//			eval('magicbook.'+so).cost.text = 'Iaia: '+cost;

				if (s == 'explosion') {
					cost = '';
				};
				if (s == 'invisibility') {
					cost = '';
				};
				if (s == 'channeling') {
					cost = '';
				};
				if (s == 'siphonmana') {
					cost = '';
				};
				if (s == 'leap') {
					cost = '';
				};
				if (s == 'leap6') {
					cost = '';
				};
				if (s == 'sacrificegoblin') {
					cost = '';
				};
				if (s == 'gating') {
					cost = '';
				};
				if (s == 'summonpitlords') {
					cost = '';
				};
				if (s == 'seduction') {
					cost = '';
				};
				if (s == 'teleportother') {
					cost = '';
				};
				if ((s == 'consumecorpse') || (s == 'benediction')) {
					cost = '';
				};

				if ((cost > stage[war_scr].obj[activeobj].nowmanna) || ((cost == 0) && (s == 'manafeed'))) {
					var disabled = true;
				} else {
					var disabled = false;
					if ((!oneCheckPossibleSpell)||(s == oneCheckPossibleSpell)) {
						was_spell = 1;
					}
				}

				var nametxt = magicbooknames[i];
				if ((powered) || (is_day_or_night(activeobj, s))) {
					switch (lang) {
						case 0:
							nametxt += ' (усиленное)';
							break;
						case 1:
							nametxt += ' (empowered)';
							break;
					};
				};
				if (s == 'angerofhorde') {
					eff = 0;
					var len = stage[war_scr].obj_array.length;
					for (var k1 = 0; k1 < len; k1++) {
						var k = stage[war_scr].obj_array[k1];
						if ((stage[war_scr].obj[k]['owner'] == stage[war_scr].obj[activeobj]['owner']) && (!stage[war_scr].obj[k]['hero']) && (!stage[war_scr].obj[k]['warmachine'])) {
							eff += stage[war_scr].obj[k]['nownumber'];
						};
					};
					stage[war_scr].obj[activeobj][s + 'effmain'] = eff;
				};
				if (stage[war_scr].obj[activeobj][s + 'effmain'] > 0) {
					if (stage[war_scr].obj[activeobj].hero) {
						var s1 = 0;
						if ((isperk(activeobj, 93)) && ((s == 'magicfist') || (s == 'raisedead'))) {
							s1 = 4;
						};
						if ((isperk(activeobj, 78)) && ((s == 'poison') || (s == 'mpoison'))) {
							s1 += 5;
						};
						if ((isperk(activeobj, 89)) && ((s == 'poison') || (s == 'mpoison'))) {
							s1 += 3;
						};
						eff = (stage[war_scr].obj[activeobj][s + 'effmain'] + stage[war_scr].obj[activeobj][s + 'effmult'] * (stage[war_scr].getspellpower(activeobj, s) + s1));
						if (stage[war_scr].obj[activeobj][s + 'effmult'] == 1.5) {
							eff = Math.round(eff);
						};
						var teff = eff;
						if (powered) {
							eff = Math.round(eff * 1.5);
						};
					} else {
						eff = Math.round(stage[war_scr].obj[activeobj][s + 'effmain'] + stage[war_scr].obj[activeobj][s + 'effmult'] * Math.pow(stage[war_scr].obj[activeobj]['nownumber'], 0.7));
						if (s == 'blind') {
							eff = Math.round(stage[war_scr].obj[activeobj][s + 'effmain'] + stage[war_scr].obj[activeobj][s + 'effmult'] * stage[war_scr].obj[activeobj]['nownumber']);
						};
						var teff = eff;
					}
					if (!powered) stage[war_scr].obj[activeobj][s + '_magiceff'] = eff;
					if ((stage[war_scr].obj[activeobj][s + 'time'] > 0) && (stage[war_scr].obj[activeobj][s + 'effmain'] > 15) && (s != 'antimagic')) {
						eff = stage[war_scr].obj[activeobj][s + 'effmain'] + '%';
					}
					if (s.substr(0, s.length - 1) == 'summoncreature') {
						if (magic[activeobj]['suc']) {
							eff = Math.floor(eff * Math.pow(0.9, magic[activeobj]['suc']['effect']));
						}
					}
					efftxt = eff;
				} else {
					efftxt = '';
					if (s == 'explosion') {
						eff = Math.round(9 + 9 * Math.pow(stage[war_scr].obj[activeobj]['nownumber'], 0.7));
						efftxt = eff;
					};
					if (s == 'channeling') {
						eff = Math.max(1, Math.floor(stage[war_scr].obj[activeobj]['nownumber'] * 0.5));
						efftxt = eff;
					};

				};
				if (stage[war_scr].obj[activeobj][s + 'time'] > 0) {
					if ((stage[war_scr].obj[activeobj].hero) || (magic[activeobj]['her'])) {
						eff = stage[war_scr].getspellpower(activeobj, s);
						if (isperk(activeobj, 89)) {
							eff += 3;
						};
						if ((isperk(activeobj, 78)) && (checkdark(s))) {
							eff += 5;
						};
					} else {
						eff = stage[war_scr].obj[activeobj]['nownumber'];
						if (magic[activeobj]['bhr']) {
							eff = Math.max(eff, Math.floor(stage[war_scr].obj[activeobj]['maxmanna'] / 5));
						}
					}

					if (eff == 0) {
						eff = 0.5;
					}
					durationtxt = eff;
				} else {
					durationtxt = '';
				}


				if (check_spell) {
					return 0;
				};
				
				var add_desktop = '';
				if (!android) add_desktop = '_Desktop';
				book_txt += '<div class="book_skill_block' + add_desktop + '" id="spell_block' + showed_cnt + '" style="background-image:url(' + stage[war_scr].subpath + 'combat/magicbook/' + so + '.png?v=' + image_ver + spells_version + ');';



				if (disabled == false) {
					book_txt += '"><div class="spell_btn' + add_desktop + '" id="spell' + showed_cnt + '" attr_disabled="0" style="cursor: pointer;" ';
				} else {
					//			book_txt +='filter: grayscale(100%);"><div class="spell_btn" style="cursor: auto;"';
					book_txt += 'opacity: 0.3;"><div attr_disabled="1" style="cursor: auto;"';
				};

				spell_id[showed_cnt] = so;
				spell_powered[showed_cnt] = powered;

				book_txt += '></div><div class="book_skill_block_container"><div class="book_skill_block_amounts book_skill_block_name">' + nametxt + '</div>';
				if (cost != '') book_txt += '<div class="book_skill_block_amounts book_skill_block_effects">' + cost + '</div>';
				if (efftxt != '') book_txt += '<div class="book_skill_block_amounts book_skill_block_cost">' + efftxt + '</div>';
				if (durationtxt != '') book_txt += '<div class="book_skill_block_amounts book_skill_block_durt">' + durationtxt + '</div>';
				book_txt += '</div></div>';



			};

			page = page * spell_per_page;
			var eco = 1;
			if (this.obj[activeobj]['hero']) {
				var len = this.obj_array.length;
				for (var k1 = 0; k1 < len; k1++) {
					i = this.obj_array[k1];
					if ((this.obj[i]['energychannel']) && (this.obj[i]['nownumber'] > 0) && (this.obj[i]['owner'] == this.obj[activeobj]['owner'])) {
						eco = 0.75;
					};
				};
				for (var k1 = 0; k1 < len; k1++) {
					i = this.obj_array[k1];
					if ((this.obj[i]['manaeater']) && (this.obj[i]['nownumber'] > 0) && (this.obj[i]['side'] != this.obj[activeobj]['side'])) {
						eco = 1.3;
					};
				};
			} else {
				var len = this.obj_array.length;
				var max = 0;
				for (var k1 = 0; k1 < len; k1++) {
					i = this.obj_array[k1];
					if ((this.obj[i]['manacurser']) && (this.obj[i]['nownumber'] > 0) && (this.obj[i]['side'] != this.obj[activeobj]['side']) && (!magic[i]['cel'])) {
						max = Math.max(max, this.obj[i]['nownumber']);
					};
				};
				max = Math.min(40, max);
				eco *= (1 + max / 100);
			};

			var cm = magicbookspells.length;
			for (zz = 0; zz <= 1; zz++) {
				var showed_cnt = 0;
				k = 0;


				for (i = 0; i < cm; i++) {
					s = magicbookspells[i];
					if (((this.obj[activeobj][s] == 1) || ((s == 'gating') && (magic[activeobj]['dem']) && (magic[activeobj]['dem']['effect'] == 1))) && (((k >= page) && (k < page + spell_per_page)) || (check_spell))) {
						if ((s == 'gating') && (this.obj[activeobj].alreadysummon)) {
							continue;
						};
						if (s == 'firstblood') {
							continue;
						};
						if ((s == 'explosion') && (this.obj[activeobj].nowmanna == 0)) {
							continue;
						};
						if ((s == 'teleport') && (this.obj[activeobj].demonic)) {
							continue;
						};
						if ((s == 'summonpitlords') && (magic[activeobj]['pit'])) {
							continue;
						};
						if ((s == 'invisibility') && (magic[activeobj]['2in']) && (magic[activeobj]['2in']['effect'] == 1)) {
							continue;
						};
						if ((s == 'seduction') && (magic[activeobj]['usd'])) {
							continue;
						};
						if ((s == 'manafeed') && (this.obj[activeobj].nowmanna == 0)) {
							continue;
						};
						showed_cnt++;
						proccedinbook(s, 0, showed_cnt, oneCheckPossibleSpell);
					};


					if ((this.obj[activeobj][s] == 1) || ((s == 'gating') && (magic[activeobj]['dem']) && (magic[activeobj]['dem']['effect'] == 1))) {
						k++;
					};
					if ((this.obj[activeobj].darkpower) && (this.obj[activeobj][s] == 1) && (magicbookchaos[i]) && (k >= page) && (k < page + spell_per_page)) {
						showed_cnt++;
						proccedinbook(s, 1, showed_cnt);
					};
					if ((this.obj[activeobj].darkpower) && (this.obj[activeobj][s] == 1) && (magicbookchaos[i])) {
						k++;
					};
					if (this.check_mass_day_or_night(activeobj, s)) {
						if ((k >= page) && (k < page + spell_per_page)) {
							var scut = s.substr(1);
							showed_cnt++;
							this.obj[activeobj][s + 'cost'] = this.obj[activeobj][scut + 'cost'] * 2;
							this.obj[activeobj][s + 'effmain'] = this.obj[activeobj][scut + 'effmain'];
							this.obj[activeobj][s + 'effmult'] = this.obj[activeobj][scut + 'effmult'];
							this.obj[activeobj][s + 'time'] = this.obj[activeobj][scut + 'time'];
							proccedinbook(s, 0, showed_cnt);
						};
						k++;
					};
				}
				if ((k > page) || (k == 0)) break;
				else {
					page = 0;
					bookpage = 0;
				};
			}

			if (check_spell) {
				return was_spell;
			};
			document.getElementById('magic_book_page').innerHTML = book_txt;
			document.getElementById('book_mana').innerHTML = '<div>' + this.obj[activeobj].nowmanna + ' / ' + this.obj[activeobj].maxmanna + '</div>';

			for (i = 1; i <= spell_per_page; i++) {
				if (document.getElementById('spell' + i)) {
					if (magic_book_hints) {
						var disabled = tointeger(document.getElementById('spell' + i).getAttribute("attr_disabled"));
						if (disabled != 1) {
							show_div_arrow('spell_block' + i, '', 'position: absolute;   left: calc(50% - 25px);   top: 90%;   width: 50px;   height: 50px;   pointer-events: none;   display: block;  transform: rotate(270deg);');
						} else {
							hide_div_arrow('spell_block' + i);
						};
					};
					if (i == 1) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release1);
					if (i == 2) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release2);
					if (i == 3) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release3);
					if (i == 4) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release4);
					if (i == 5) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release5);
					if (i == 6) document.getElementById('spell' + i).addEventListener("mouseup", spell_button_release6);
				};
			};
			//	magicbook.mannainfo.mannanow.text = this.obj[activeobj].nowmanna+' / '+this.obj[activeobj].maxmanna;
		}

			show_war_buttons = function () {
				//		hide_div_arrow("wait_button");
				if (firstbattle) {
					stage[war_scr].commandsproc();
				};
				if (buttons_visible['win_Mission']) return 0;
				if (bt_restricted) return 0;
				if (fast_battle_off) {
					hide_war_buttons(1);
					return 0;
				};
				if (info_button) {
					hide_button('info_on');
					show_button('info_off');
					check_i_pressed_level();
				} else {
					show_button('info_on');
					if (test_mode) show_button('pause_button');
					hide_button('info_off');
				};
				check_fast_but();
				if (command != '') return 0;
				if (activeobj == 0) return 0;

				shift_ok = false;
				stage[war_scr].checkthrower(activeobj);
				if((stage[war_scr].obj[activeobj].lastMagicUse)&&(magicbookspells.includes(stage[war_scr].obj[activeobj].lastMagicUse))&&(stage.pole.showmagicbook(0, 0, true, stage[war_scr].obj[activeobj].lastMagicUse))) {
					document.getElementById("lastMagicSrc").src = "https://daily.heroeswm.ru/i/magicbook/" + stage[war_scr].obj[activeobj].lastMagicUse + ".png"	
					show_button('lastMagic_button');
					spell_id[0] = stage[war_scr].obj[activeobj].lastMagicUse;
					spell_powered[0] = stage[war_scr].obj[activeobj].lastMagicUse_powered;
				} else {
					hide_button('lastMagic_button');
				}

				if ((((stage[war_scr].obj[activeobj].shooter) && (stage[war_scr].obj[activeobj].shots > 0)) || (stage[war_scr].obj[activeobj].strikeandreturn)) && (!stage[war_scr].obj[activeobj].hero) && (!finished) && (stage[war_scr].get_unit_speed(activeobj) > 0) && (!stage[war_scr].obj[activeobj].shootonly)) {
					if ((stage[war_scr].obj[activeobj].strikeandreturn) || (stage[war_scr].check_possible_attack()) || (stage[war_scr].obj[activeobj].getside() != stage[war_scr].obj[activeobj].side)) {
						shift_ok = true;
						shift_button = false;
						if (!classic_chat) {
							show_button('shift_on');
						};
						hide_button('shift_off');
					} else {
						shift_ok = false;
						hide_button('shift_on');
						hide_button('shift_off');
					};
				};
				stage[war_scr].calcpossiblemagic();

				if (command == '') stage[war_scr].checkrune(activeobj);


				if (!battle_ended) {
					if ((btype == _QUESTWAR) || (btypeold == _UNIGUILD) || (btypeold == _CAMPAIGN_WAR)) {
						btn_defeat = 0;
						show_button('btn_defeat');
					};
					if (classic_chat) {
						show_button('wait_button2');
						show_button('defend_button2');
					} else {
						show_button('wait_button');
						show_button('defend_button');
					};
				};

				if (android) {
					check_expand();
				};
			};
		}
	}	
	
}